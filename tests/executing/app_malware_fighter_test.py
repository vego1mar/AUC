import unittest
import logging
from collector.requesting import InvocationRequest
from collector.requesting import Target
from collector.requesting import SpaceName
from collector.triggers import SetWorkspace
from collector.executing import ExecutionOrderEntry
from collector.executing import ExecutionOrder
from collector.executing import InfoCollector
from collector.helpers import configure_logging
from collector.helpers import decode_base64
from collector.helpers import get_web_space
from collector.helpers import get_entry_for_dobreprogramy_pl

configure_logging(r"../test_log.txt")
logging.debug("Tests for: IObit Malware Fighter")


class MalwareFighterTestData:
    APP_NAME = "Malware Fighter"
    WEB_SPACE_URL_1 = "https://www.iobit.com/en/malware-fighter.php"
    WEB_SPACE_URL_2 = "https://www.dobreprogramy.pl/IObit-Malware-Fighter-Free,Program,Windows,25512.html"
    WEB_SPACE_HTML_PATH_2 = r"../resources/imf_web_Windows.base64"

    def __init__(self):
        self.execution_order = ExecutionOrder()
        self.execution_order.add_entry(get_entry_1(), True)
        self.execution_order.add_entry(get_entry_2(), True)
        self.expected_win_ver = decode_base64(b'Ni42LjEuNTE1Mw==')
        self.expected_win_date = decode_base64(b'MjAxOS0wMy0yNw==')
        self.expected_win_size = decode_base64(b'NDcsOTggTUI=')


def get_win_exe():
    win_exe = b'aHR0cHM6Ly9lbi5zb2Z0b25pYy5jb20vZG93bmxvYWQtbGF1bmNoP3Rva2VuPWV5SmhiR2NpT2lKSVV6STFOaUlzSW5SNWNDSTZ' \
              b'Ja3BYVkNKOS5leUprYjNkdWJHOWhaRlI1Y0dVaU9pSnBiblJsY201aGJFUnZkMjVzYjJGa0lpd2laRzkzYm14dllXUlZjbXdpT2' \
              b'lKb2RIUndjem92TDJkelppMW1iQzV6YjJaMGIyNXBZeTVqYjIwdk9UWmxMek5sTUM4eFpUTTNPRFUwWXpSbFl6UmtPV1kxWkRJe' \
              b'FpURTNOalJpTlRFeVlUY3lOVFEwTDBsUFltbDBMVTFoYkhkaGNtVXRSbWxuYUhSbGNpMVRaWFIxY0M1bGVHVV9SWGh3YVhKbGN6' \
              b'MHhOVFUxTWpjMk16ZzVKbE5wWjI1aGRIVnlaVDAxTm1JNU1EZGtOVGxsTnpNd1pURXlaak5sWldObFptTTJPVFJqWTJReFlXTTN' \
              b'ZalJqWXpZMEpsTkVYM1Z6WldROUptTm9ZVzV1Wld3OVYwVkNKbVprYUQxdWJ5WnBaRjltYVd4bFBUQmhOamRqT1RObExUazJaRF' \
              b'V0TVRGbE5pMDVZekl3TFRBd01UWXpaV1E0TXpObE55WnBibk4wWVc1alpUMXpiMlowYjI1cFkxOWxiaVowZVhCbFBWQlNUMGRTU' \
              b'VUwbWRYSnNQV2gwZEhCek9pOHZhVzlpYVhRdGJXRnNkMkZ5WlMxbWFXZG9kR1Z5TG1WdUxuTnZablJ2Ym1sakxtTnZiU1pHYVd4' \
              b'bGJtRnRaVDFKVDJKcGRDMU5ZV3gzWVhKbExVWnBaMmgwWlhJdFUyVjBkWEF1WlhobElpd2lZWEJ3U1dRaU9pSXdZVFkzWXprelp' \
              b'TMDVObVExTFRFeFpUWXRPV015TUMwd01ERTJNMlZrT0RNelpUY2lMQ0pwWVhRaU9qRTFOVFV5TXpjeE16WXNJbVY0Y0NJNk1UVT' \
              b'FOVEkwTURjek5uMC52Ukx3OTczZkJONW9ObVBHam9uVUtta21xVlFMbmVscWRjOEtVakF2X05v'
    return decode_base64(win_exe)


def get_entry_1():
    app_website = str(MalwareFighterTestData.WEB_SPACE_URL_1)
    req_01 = InvocationRequest(Target(SpaceName.WORK, True, "app_website"), SetWorkspace(app_website))
    req_02 = InvocationRequest(Target(SpaceName.WORK, True, "win_exe"), SetWorkspace(get_win_exe()))
    chain_request = (req_01, req_02)
    return ExecutionOrderEntry(chain_request, str())


def get_entry_2():
    web_space = get_web_space(MalwareFighterTestData.WEB_SPACE_HTML_PATH_2)
    return get_entry_for_dobreprogramy_pl(web_space, "win_ver", "win_date", "win_size")


class MalwareFighterTest(unittest.TestCase):
    def test_package_collecting(self):
        # given
        dt = MalwareFighterTestData()
        collector = InfoCollector(dt.APP_NAME, dt.execution_order)

        # when
        collector.collect()

        # then
        self.assertEqual(dt.APP_NAME, collector.get_app_name())
        self.assertEqual(dt.WEB_SPACE_URL_1, collector.get_collectibles()['app_website'])
        self.assertEqual(get_win_exe(), collector.get_collectibles()['win_exe'])
        self.assertEqual(dt.expected_win_ver, collector.get_collectibles()['win_ver'])
        self.assertEqual(dt.expected_win_date, collector.get_collectibles()['win_date'])
        self.assertEqual(dt.expected_win_size, collector.get_collectibles()['win_size'])


if __name__ == '__main__':
    unittest.main()
